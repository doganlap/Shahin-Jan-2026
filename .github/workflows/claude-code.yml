name: Claude Code

on:
  # Trigger on issue comments
  issue_comment:
    types: [created]
  # Trigger on PR review comments
  pull_request_review_comment:
    types: [created]
  # Trigger on new issues assigned to Claude
  issues:
    types: [opened, assigned]
  # Trigger on PR reviews
  pull_request_review:
    types: [submitted]

jobs:
  claude-code:
    # Only run if the comment mentions @claude or issue is assigned to claude-code[bot]
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.issue.assignee.login == 'claude-code[bot]')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ABP CLI
        run: dotnet tool install -g Volo.Abp.Cli || true

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Optional: Specify allowed tools
          allowed_tools: |
            Read
            Write
            Edit
            Bash
            Glob
            Grep
            LS
          # Optional: Custom system prompt
          custom_instructions: |
            You are working on the GRC (Governance, Risk, and Compliance) System.
            This is an ABP Framework Blazor Server application using .NET 8.

            Key project structure:
            - src/Grc.Blazor - Blazor Server UI
            - src/Grc.Application - Application services
            - src/Grc.Domain - Domain entities and logic
            - src/Grc.EntityFrameworkCore - EF Core with PostgreSQL

            When making changes:
            1. Follow ABP Framework conventions
            2. Use async/await patterns
            3. Follow existing code style
            4. Add appropriate error handling
            5. Update related tests if applicable

            Database: PostgreSQL
            Authentication: ABP Identity with Azure AD integration

          # Optional: Max turns for conversation
          max_turns: 10

  # Separate job for fixing CI failures
  fix-ci-failures:
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude fix ci')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.issue.pull_request && github.head_ref || github.ref }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Get failed workflow run
        id: failed-run
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              status: 'failure',
              per_page: 1
            });
            if (runs.workflow_runs.length > 0) {
              return runs.workflow_runs[0].id;
            }
            return null;

      - name: Run Claude Code to fix CI
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_instructions: |
            A CI workflow has failed. Please:
            1. Analyze the error logs
            2. Identify the root cause
            3. Propose and implement a fix
            4. Commit the changes with a descriptive message
            5. Push to create/update the PR

            This is an ABP Framework .NET 8 application.
