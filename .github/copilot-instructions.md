# Copilot instructions for this repo

- Tech stack: .NET 8 ABP solution with layered projects (`Grc.Domain.Shared`, `Grc.Domain`, `Grc.Application.Contracts`, `Grc.Application`, `Grc.Blazor`, `Grc.EntityFrameworkCore`). Blazor UI uses Arabic menu labels and permission-gated navigation.
- Policy engine is first-class. Core types live in `src/Grc.Application/Policy/` (`PolicyEnforcer`, `PolicyStore`, `PolicyContext`, `PolicyAuditLogger`, `DotPathResolver`, `MutationApplier`). Policies load from `etc/policies` (see `grc-baseline.yml`), are cached by name, and are evaluated deterministically (ascending `priority`, short-circuit, deny-overrides). Cache invalidation is explicit via `PolicyStore.InvalidateCache`.
- AppServices inherit `BasePolicyAppService` and **must call `EnforceAsync(action, resourceType, resource, environment?)`** before mutating or returning sensitive data. `EnforceAsync` builds context with current user/tenant plus roles from `IRoleResolver`; environment defaults to `EnvironmentProvider` or `ASPNETCORE_ENVIRONMENT` (`dev|staging|prod`). Follow existing verbs (`"create"`, `"update"`, `"delete"`, `"view"`, etc.) and resourceType names matching entity (e.g., `"Evidence"`).
- Permissions are centralized in `src/Grc.Domain.Shared/Permissions/GrcPermissions.cs` and defined via `GrcPermissionDefinitionProvider`. Keep ABP `[Authorize]` attributes and menu visibility consistent with these constants. Arabic menu configuration lives in `src/Grc.Blazor/Menus/GrcMenuContributor.cs`; ensure new pages wire permissions there.
- DTO mapping: AutoMapper profiles live in `GrcApplicationAutoMapperProfile` and `AdminApplicationAutoMapperProfile` (registered in `GrcApplicationModule`). Add or adjust maps there; avoid inline mapping in services.
- Role profile services: implementations in `src/Grc.Application/Roles/` (`RoleProfileAppService`, `RoleProfileIntegrationService`) are registered as transients in `GrcApplicationModule`; reuse these for role/profile flows.
- Build and tooling: restore/build with `dotnet restore && dotnet build` (Release build script: `scripts/build.sh`). Solution-wide analyzers are enabled via `Directory.Build.props` (StyleCop, NetAnalyzers, SecurityCodeScan, AsyncFixer, ConfigureAwaitChecker). Follow `.editorconfig`/StyleCop expectations; warnings are not treated as errors but should be clean.
- Development setup (see `docs/DEVELOPMENT_SETUP.md`): recommends SonarLint, C# Dev Kit, optional Snyk/GitGuardian; sample pre-commit hook runs `dotnet build`, `dotnet format --verify-no-changes`, and security scans.
- Policy artifacts are copied from the content root; when adding new YAMLs ensure they are included in output (set `Copy to Output Directory` if needed) so `AppContext.BaseDirectory/etc/policies` resolves at runtime.
- Quick orientation docs: `README.md` (overview), `QUICK_REFERENCE.md` (entities/services/pages/permissions), `BUILD_INSTRUCTIONS.md` (recent fixes and packages), `COMPLETE_SYSTEM_INVENTORY.md` (full coverage).
