@page "/compliance-calendar"
@using Grc.Application.Contracts.ComplianceEvent
@using Grc.Permissions
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(GrcPermissions.ComplianceCalendar.View)]

<PageTitle>تقويم الامتثال</PageTitle>

<h3>تقويم الامتثال</h3>

@if (isLoading)
{
    <p>جاري التحميل...</p>
}
else
{
    <div class="mb-3">
        <div class="row">
            <div class="col-md-6">
                <input type="text" class="form-control" placeholder="بحث..." @bind="filter" @bind:event="oninput" @bind:after="OnFilterChanged" />
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="selectedStatus" @bind:event="onchange" @bind:after="OnFilterChanged">
                    <option value="">جميع الحالات</option>
                    <option value="Pending">قيد الانتظار</option>
                    <option value="Completed">مكتملة</option>
                    <option value="Overdue">متأخرة</option>
                </select>
            </div>
            <div class="col-md-3">
                <AuthorizeView Permission="@GrcPermissions.ComplianceCalendar.Manage">
                    <Authorized>
                        <a href="/compliance-calendar/create" class="btn btn-primary">إضافة حدث امتثال جديد</a>
                    </Authorized>
                </AuthorizeView>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <button class="btn btn-sm btn-info" @onclick="LoadUpcoming">القادمة (30 يوم)</button>
        <button class="btn btn-sm btn-warning" @onclick="LoadOverdue">المتأخرة</button>
    </div>

    @if (result != null && result.Items != null && result.Items.Any())
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>الاسم</th>
                    <th>النوع</th>
                    <th>تاريخ الاستحقاق</th>
                    <th>الأولوية</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in result.Items)
                {
                    <tr>
                        <td>@item.Name</td>
                        <td>@item.EventType</td>
                        <td>@item.DueDate?.ToString("yyyy-MM-dd")</td>
                        <td>@item.Priority</td>
                        <td>@item.Status</td>
                        <td>
                            <a href="/compliance-calendar/edit/@item.Id" class="btn btn-sm btn-secondary">تعديل</a>
                            <AuthorizeView Permission="@GrcPermissions.ComplianceCalendar.Manage">
                                <Authorized>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteItem(item.Id)">حذف</button>
                                </Authorized>
                            </AuthorizeView>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (result.TotalCount > result.Items.Count)
        {
            <nav>
                <ul class="pagination">
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(currentPage == i ? "active" : "")">
                            <button class="page-link" @onclick="() => LoadPage(i)">@i</button>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
    else if (!isLoading)
    {
        <p>لا توجد بيانات</p>
    }
}

<ErrorDialog @bind-Error="currentError" />

@code {
    [Inject] private IComplianceCalendarAppService ComplianceCalendarAppService { get; set; } = null!;
    [Inject] private ErrorToastService ErrorToastService { get; set; } = null!;
    
    private PagedResultDto<ComplianceEventDto>? result;
    private bool isLoading = true;
    private string filter = string.Empty;
    private string? selectedStatus;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private ErrorResponseDto? currentError;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            var input = new ComplianceEventListInputDto
            {
                Filter = string.IsNullOrWhiteSpace(filter) ? null : filter,
                Status = selectedStatus,
                SkipCount = (currentPage - 1) * pageSize,
                MaxResultCount = pageSize,
                Sorting = "DueDate ASC"
            };

            result = await ComplianceCalendarAppService.GetListAsync(input);
            totalPages = (int)Math.Ceiling((double)result.TotalCount / pageSize);
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "حدث خطأ أثناء تحميل البيانات", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل تحميل البيانات", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadUpcoming()
    {
        try
        {
            isLoading = true;
            var items = await ComplianceCalendarAppService.GetUpcomingAsync(30);
            result = new PagedResultDto<ComplianceEventDto>(items.Count, items);
            totalPages = 1;
            currentPage = 1;
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "حدث خطأ أثناء تحميل البيانات", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل تحميل البيانات", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadOverdue()
    {
        try
        {
            isLoading = true;
            var items = await ComplianceCalendarAppService.GetOverdueAsync();
            result = new PagedResultDto<ComplianceEventDto>(items.Count, items);
            totalPages = 1;
            currentPage = 1;
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "حدث خطأ أثناء تحميل البيانات", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل تحميل البيانات", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnFilterChanged()
    {
        currentPage = 1;
        await LoadDataAsync();
    }

    private async Task LoadPage(int page)
    {
        currentPage = page;
        await LoadDataAsync();
    }

    private async Task DeleteItem(Guid id)
    {
        try
        {
            await ComplianceCalendarAppService.DeleteAsync(id);
            await ErrorToastService.ShowSuccessAsync("تم الحذف بنجاح");
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "فشل حذف الحدث", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل الحذف", ex.Message);
        }
    }
}
