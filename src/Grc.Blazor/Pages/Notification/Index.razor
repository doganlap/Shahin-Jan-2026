@page "/notifications"
@using Grc.Application.Contracts.Notification
@using Grc.Permissions
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(GrcPermissions.Notifications.View)]

<PageTitle>الإشعارات</PageTitle>

<h3>الإشعارات</h3>

@if (isLoading)
{
    <p>جاري التحميل...</p>
}
else
{
    <div class="mb-3">
        <div class="row">
            <div class="col-md-6">
                <input type="text" class="form-control" placeholder="بحث..." @bind="filter" @bind:event="oninput" @bind:after="OnFilterChanged" />
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="isReadFilter" @bind:event="onchange" @bind:after="OnFilterChanged">
                    <option value="">الكل</option>
                    <option value="false">غير مقروءة</option>
                    <option value="true">مقروءة</option>
                </select>
            </div>
            <div class="col-md-3">
                <AuthorizeView Permission="@GrcPermissions.Notifications.Manage">
                    <Authorized>
                        <a href="/notifications/create" class="btn btn-primary">إضافة إشعار جديد</a>
                        <button class="btn btn-secondary" @onclick="MarkAllAsRead">تعليم الكل كمقروء</button>
                    </Authorized>
                </AuthorizeView>
            </div>
        </div>
    </div>

    <div class="mb-2">
        <span class="badge bg-info">غير مقروءة: @unreadCount</span>
    </div>

    @if (result != null && result.Items != null && result.Items.Any())
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>العنوان</th>
                    <th>الرسالة</th>
                    <th>النوع</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in result.Items)
                {
                    <tr class="@(item.IsRead ? "" : "table-warning")">
                        <td>@item.Title</td>
                        <td>@item.Message</td>
                        <td>@item.NotificationType</td>
                        <td>@(item.IsRead ? "مقروءة" : "غير مقروءة")</td>
                        <td>
                            @if (!item.IsRead)
                            {
                                <button class="btn btn-sm btn-success" @onclick="() => MarkAsRead(item.Id)">تعليم كمقروء</button>
                            }
                            <AuthorizeView Permission="@GrcPermissions.Notifications.Manage">
                                <Authorized>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteItem(item.Id)">حذف</button>
                                </Authorized>
                            </AuthorizeView>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (result.TotalCount > result.Items.Count)
        {
            <nav>
                <ul class="pagination">
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(currentPage == i ? "active" : "")">
                            <button class="page-link" @onclick="() => LoadPage(i)">@i</button>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
    else if (!isLoading)
    {
        <p>لا توجد بيانات</p>
    }
}

<ErrorDialog @bind-Error="currentError" />

@code {
    [Inject] private INotificationAppService NotificationAppService { get; set; } = null!;
    [Inject] private ErrorToastService ErrorToastService { get; set; } = null!;
    
    private PagedResultDto<NotificationDto>? result;
    private bool isLoading = true;
    private string filter = string.Empty;
    private string? isReadFilter;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private int unreadCount = 0;
    private ErrorResponseDto? currentError;

    protected override async Task OnInitializedAsync()
    {
        await LoadUnreadCountAsync();
        await LoadDataAsync();
    }

    private async Task LoadUnreadCountAsync()
    {
        try
        {
            unreadCount = await NotificationAppService.GetUnreadCountAsync();
        }
        catch (Exception ex)
        {
            await ErrorToastService.ShowErrorAsync("فشل تحميل عدد غير المقروءة", ex.Message);
        }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            var input = new NotificationListInputDto
            {
                Filter = string.IsNullOrWhiteSpace(filter) ? null : filter,
                IsRead = string.IsNullOrWhiteSpace(isReadFilter) ? null : bool.Parse(isReadFilter),
                SkipCount = (currentPage - 1) * pageSize,
                MaxResultCount = pageSize,
                Sorting = "CreationTime DESC"
            };

            result = await NotificationAppService.GetListAsync(input);
            totalPages = (int)Math.Ceiling((double)result.TotalCount / pageSize);
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "حدث خطأ أثناء تحميل البيانات", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل تحميل البيانات", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnFilterChanged()
    {
        currentPage = 1;
        await LoadDataAsync();
    }

    private async Task LoadPage(int page)
    {
        currentPage = page;
        await LoadDataAsync();
    }

    private async Task MarkAsRead(Guid id)
    {
        try
        {
            await NotificationAppService.MarkAsReadAsync(id);
            await ErrorToastService.ShowSuccessAsync("تم تعليم الإشعار كمقروء");
            await LoadUnreadCountAsync();
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "فشل تعليم الإشعار كمقروء", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل العملية", ex.Message);
        }
    }

    private async Task MarkAllAsRead()
    {
        try
        {
            await NotificationAppService.MarkAllAsReadAsync();
            await ErrorToastService.ShowSuccessAsync("تم تعليم جميع الإشعارات كمقروءة");
            await LoadUnreadCountAsync();
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "فشل تعليم جميع الإشعارات كمقروءة", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل العملية", ex.Message);
        }
    }

    private async Task DeleteItem(Guid id)
    {
        try
        {
            await NotificationAppService.DeleteAsync(id);
            await ErrorToastService.ShowSuccessAsync("تم الحذف بنجاح");
            await LoadUnreadCountAsync();
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "فشل حذف الإشعار", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل الحذف", ex.Message);
        }
    }
}
