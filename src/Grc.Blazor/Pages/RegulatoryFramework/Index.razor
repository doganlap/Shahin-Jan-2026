@page "/frameworks"
@using Grc.Application.Contracts.RegulatoryFramework
@using Grc.Permissions
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(GrcPermissions.Frameworks.View)]

<PageTitle>مكتبة الأطر التنظيمية</PageTitle>

<h3>مكتبة الأطر التنظيمية</h3>

@if (isLoading)
{
    <p>جاري التحميل...</p>
}
else
{
    <div class="mb-3">
        <div class="row">
            <div class="col-md-6">
                <input type="text" class="form-control" placeholder="بحث..." @bind="filter" @bind:event="oninput" @bind:after="OnFilterChanged" />
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="selectedRegion" @bind:event="onchange" @bind:after="OnFilterChanged">
                    <option value="">جميع المناطق</option>
                    <option value="Middle East">الشرق الأوسط</option>
                    <option value="Europe">أوروبا</option>
                    <option value="North America">أمريكا الشمالية</option>
                </select>
            </div>
            <div class="col-md-3">
                <AuthorizeView Permission="@GrcPermissions.Frameworks.Create">
                    <Authorized>
                        <a href="/frameworks/create" class="btn btn-primary">إضافة إطار تنظيمي جديد</a>
                    </Authorized>
                </AuthorizeView>
            </div>
        </div>
    </div>

    @if (result != null && result.Items != null && result.Items.Any())
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>الاسم</th>
                    <th>الوصف</th>
                    <th>النوع</th>
                    <th>المنطقة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in result.Items)
                {
                    <tr>
                        <td>@item.Name</td>
                        <td>@item.Description</td>
                        <td>@item.FrameworkType</td>
                        <td>@item.Jurisdiction</td>
                        <td>
                            <a href="/frameworks/edit/@item.Id" class="btn btn-sm btn-secondary">تعديل</a>
                            <AuthorizeView Permission="@GrcPermissions.Frameworks.Delete">
                                <Authorized>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteItem(item.Id)">حذف</button>
                                </Authorized>
                            </AuthorizeView>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (result.TotalCount > result.Items.Count)
        {
            <nav>
                <ul class="pagination">
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(currentPage == i ? "active" : "")">
                            <button class="page-link" @onclick="() => LoadPage(i)">@i</button>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
    else if (!isLoading)
    {
        <p>لا توجد بيانات</p>
    }
}

<ErrorDialog @bind-Error="currentError" />

@code {
    [Inject] private IRegulatoryFrameworkAppService RegulatoryFrameworkAppService { get; set; } = null!;
    [Inject] private ErrorToastService ErrorToastService { get; set; } = null!;
    
    private PagedResultDto<RegulatoryFrameworkDto>? result;
    private bool isLoading = true;
    private string filter = string.Empty;
    private string? selectedRegion;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private ErrorResponseDto? currentError;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            var input = new RegulatoryFrameworkListInputDto
            {
                Filter = string.IsNullOrWhiteSpace(filter) ? null : filter,
                Region = selectedRegion,
                SkipCount = (currentPage - 1) * pageSize,
                MaxResultCount = pageSize,
                Sorting = "CreationTime DESC"
            };

            result = await RegulatoryFrameworkAppService.GetListAsync(input);
            totalPages = (int)Math.Ceiling((double)result.TotalCount / pageSize);
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "حدث خطأ أثناء تحميل البيانات", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل تحميل البيانات", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnFilterChanged()
    {
        currentPage = 1;
        await LoadDataAsync();
    }

    private async Task LoadPage(int page)
    {
        currentPage = page;
        await LoadDataAsync();
    }

    private async Task DeleteItem(Guid id)
    {
        try
        {
            await RegulatoryFrameworkAppService.DeleteAsync(id);
            await ErrorToastService.ShowSuccessAsync("تم الحذف بنجاح");
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "فشل حذف الإطار التنظيمي", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل الحذف", ex.Message);
        }
    }
}
