@page "/admin/users/{Id:guid}/edit"
@using Grc.Application.Contracts.Admin.UserManagement
@using Grc.Application.Contracts.Admin.RoleManagement
@using Volo.Abp.Application.Dtos
@attribute [Authorize(Grc.Permissions.GrcPermissions.Admin.Users)]

<PageTitle>تعديل مستخدم</PageTitle>

<h3>تعديل مستخدم</h3>

@if (loading)
{
    <p>جاري التحميل...</p>
}
else if (user != null)
{
    <EditForm Model="@updateInput" OnValidSubmit="@UpdateUser">
        <DataAnnotationsValidator />
        
        <div class="mb-3">
            <label class="form-label">اسم المستخدم</label>
            <InputText Value="@user.UserName" class="form-control" disabled />
        </div>

        <div class="mb-3">
            <label class="form-label">البريد الإلكتروني *</label>
            <InputText type="email" @bind-Value="updateInput.Email" class="form-control" />
            <ValidationMessage For="@(() => updateInput.Email)" />
        </div>

        <div class="mb-3">
            <label class="form-label">الاسم</label>
            <InputText @bind-Value="updateInput.Name" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">اللقب</label>
            <InputText @bind-Value="updateInput.Surname" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">رقم الهاتف</label>
            <InputText @bind-Value="updateInput.PhoneNumber" class="form-control" />
        </div>

        <div class="mb-3">
            <InputCheckbox @bind-Value="updateInput.IsActive" class="form-check-input" />
            <label class="form-check-label">نشط</label>
        </div>

        <div class="mb-3">
            <label class="form-label">الأدوار</label>
            @if (loadingRoles)
            {
                <p>جاري التحميل...</p>
            }
            else
            {
                <div class="form-check">
                    @foreach (var role in availableRoles.Items)
                    {
                        <div class="form-check">
                            <input type="checkbox" 
                                checked="@(updateInput.RoleNames.Contains(role.Name))"
                                @onchange="@((ChangeEventArgs e) => OnRoleChanged(role.Name, (bool)(e.Value ?? false)))"
                                class="form-check-input" 
                                id="role-@role.Id" />
                            <label class="form-check-label" for="role-@role.Id">
                                @role.Name
                            </label>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="mb-3">
            <button type="submit" class="btn btn-primary">حفظ</button>
            <a href="/admin/users" class="btn btn-secondary">إلغاء</a>
        </div>
    </EditForm>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private UserDto? user;
    private UpdateUserDto updateInput = new();
    private bool loading = true;
    private PagedResultDto<RoleDto> availableRoles = new();
    private bool loadingRoles = true;

    [Inject]
    private IUserManagementAppService UserManagementAppService { get; set; } = null!;
    [Inject]
    private IRoleManagementAppService RoleManagementAppService { get; set; } = null!;
    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadUser(), LoadRoles());
    }

    private async Task LoadUser()
    {
        loading = true;
        try
        {
            user = await UserManagementAppService.GetAsync(Id);
            updateInput.Email = user.Email;
            updateInput.Name = user.Name;
            updateInput.Surname = user.Surname;
            updateInput.PhoneNumber = user.PhoneNumber;
            updateInput.IsActive = user.IsActive;
            updateInput.RoleNames = user.Roles.ToList();
        }
        catch (Exception ex)
        {
            // TODO: Handle error properly
            Console.WriteLine($"Error loading user: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadRoles()
    {
        loadingRoles = true;
        try
        {
            var input = new RoleListInputDto { MaxResultCount = 100 };
            availableRoles = await RoleManagementAppService.GetListAsync(input);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading roles: {ex.Message}");
        }
        finally
        {
            loadingRoles = false;
        }
    }

    private void OnRoleChanged(string roleName, bool isChecked)
    {
        if (isChecked && !updateInput.RoleNames.Contains(roleName))
        {
            updateInput.RoleNames.Add(roleName);
        }
        else if (!isChecked && updateInput.RoleNames.Contains(roleName))
        {
            updateInput.RoleNames.Remove(roleName);
        }
    }

    private async Task UpdateUser()
    {
        try
        {
            await UserManagementAppService.UpdateAsync(Id, updateInput);
            NavigationManager.NavigateTo("/admin/users");
        }
        catch (Exception ex)
        {
            // TODO: Handle error properly
            Console.WriteLine($"Error updating user: {ex.Message}");
        }
    }
}
