@page "/subscriptions"
@using Grc.Application.Contracts.Subscriptions
@using Grc.Permissions
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(GrcPermissions.Subscriptions.View)]

<PageTitle>الاشتراكات</PageTitle>

<h3>الاشتراكات</h3>

@if (isLoading)
{
    <p>جاري التحميل...</p>
}
else
{
    <div class="mb-3">
        <div class="row">
            <div class="col-md-6">
                <input type="text" class="form-control" placeholder="بحث..." @bind="filter" @bind:event="oninput" @bind:after="OnFilterChanged" />
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="isActiveFilter" @bind:event="onchange" @bind:after="OnFilterChanged">
                    <option value="">الكل</option>
                    <option value="true">نشطة</option>
                    <option value="false">غير نشطة</option>
                </select>
            </div>
            <div class="col-md-3">
                <AuthorizeView Permission="@GrcPermissions.Subscriptions.Manage">
                    <Authorized>
                        <a href="/subscriptions/create" class="btn btn-primary">إضافة اشتراك جديد</a>
                    </Authorized>
                </AuthorizeView>
            </div>
        </div>
    </div>

    @if (result != null && result.Items != null && result.Items.Any())
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>الاسم</th>
                    <th>نوع الخطة</th>
                    <th>تاريخ البدء</th>
                    <th>تاريخ الانتهاء</th>
                    <th>السعر</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in result.Items)
                {
                    <tr>
                        <td>@item.Name</td>
                        <td>@item.PlanType</td>
                        <td>@item.StartDate.ToString("yyyy-MM-dd")</td>
                        <td>@(item.EndDate?.ToString("yyyy-MM-dd") ?? "لا يوجد")</td>
                        <td>@item.Price @item.Currency</td>
                        <td>@(item.IsActive ? "نشطة" : "غير نشطة")</td>
                        <td>
                            <a href="/subscriptions/edit/@item.Id" class="btn btn-sm btn-secondary">تعديل</a>
                            @if (item.IsActive)
                            {
                                <AuthorizeView Permission="@GrcPermissions.Subscriptions.Manage">
                                    <Authorized>
                                        <button class="btn btn-sm btn-warning" @onclick="() => Deactivate(item.Id)">تعطيل</button>
                                    </Authorized>
                                </AuthorizeView>
                            }
                            else
                            {
                                <AuthorizeView Permission="@GrcPermissions.Subscriptions.Manage">
                                    <Authorized>
                                        <button class="btn btn-sm btn-success" @onclick="() => Activate(item.Id)">تفعيل</button>
                                    </Authorized>
                                </AuthorizeView>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (result.TotalCount > result.Items.Count)
        {
            <nav>
                <ul class="pagination">
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(currentPage == i ? "active" : "")">
                            <button class="page-link" @onclick="() => LoadPage(i)">@i</button>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
    else if (!isLoading)
    {
        <p>لا توجد بيانات</p>
    }
}

<ErrorDialog @bind-Error="currentError" />

@code {
    [Inject] private ISubscriptionAppService SubscriptionAppService { get; set; } = null!;
    [Inject] private ErrorToastService ErrorToastService { get; set; } = null!;
    
    private PagedResultDto<SubscriptionDto>? result;
    private bool isLoading = true;
    private string filter = string.Empty;
    private string? isActiveFilter;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private ErrorResponseDto? currentError;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            var input = new SubscriptionListInputDto
            {
                Filter = string.IsNullOrWhiteSpace(filter) ? null : filter,
                IsActive = string.IsNullOrWhiteSpace(isActiveFilter) ? null : bool.Parse(isActiveFilter),
                SkipCount = (currentPage - 1) * pageSize,
                MaxResultCount = pageSize,
                Sorting = "CreationTime DESC"
            };

            result = await SubscriptionAppService.GetListAsync(input);
            totalPages = (int)Math.Ceiling((double)result.TotalCount / pageSize);
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "حدث خطأ أثناء تحميل البيانات", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل تحميل البيانات", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnFilterChanged()
    {
        currentPage = 1;
        await LoadDataAsync();
    }

    private async Task LoadPage(int page)
    {
        currentPage = page;
        await LoadDataAsync();
    }

    private async Task Activate(Guid id)
    {
        try
        {
            await SubscriptionAppService.ActivateAsync(id);
            await ErrorToastService.ShowSuccessAsync("تم تفعيل الاشتراك بنجاح");
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "فشل تفعيل الاشتراك", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل العملية", ex.Message);
        }
    }

    private async Task Deactivate(Guid id)
    {
        try
        {
            await SubscriptionAppService.DeactivateAsync(id);
            await ErrorToastService.ShowSuccessAsync("تم تعطيل الاشتراك بنجاح");
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            currentError = new ErrorResponseDto { Message = "فشل تعطيل الاشتراك", Details = ex.Message };
            await ErrorToastService.ShowErrorAsync("فشل العملية", ex.Message);
        }
    }
}
