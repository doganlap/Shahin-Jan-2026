@model StepAOrganizationIdentityDto
@using GrcMvc.Models.DTOs
@{
    ViewData["Title"] = "Organization Identity - Onboarding Wizard";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var summary = ViewData["WizardSummary"] as WizardSummaryDto;
    var tenantId = summary?.TenantId ?? Guid.Empty;
}

<div class="d-flex">
    <!-- Sidebar -->
    @await Html.PartialAsync("_WizardSidebar", summary)

    <!-- Main Content -->
    <div class="flex-grow-1 p-4">
        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-building text-primary me-2"></i>
                        Step A: Organization Identity & Tenancy
                    </h2>
                    <p class="text-muted mb-0">
                        Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ù†Ø¸Ù…Ø© ÙˆØ§Ù„Ù…Ø³ØªØ£Ø¬Ø± | Questions 1-13
                    </p>
                </div>
                <span class="badge bg-primary fs-6">Step 1 of 12</span>
            </div>

            <form asp-action="StepA" asp-route-tenantId="@tenantId" method="post" id="stepAForm">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="All" class="alert alert-danger" role="alert" style="display: none;"></div>

                <!-- Section: Legal Name -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-id-card me-2"></i>Organization Legal Name</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="OrganizationLegalNameEn" class="form-label">
                                    <span class="text-danger">*</span> Legal Name (English)
                                </label>
                                <input asp-for="OrganizationLegalNameEn" class="form-control"
                                       placeholder="e.g., Saudi Arabian Banking Corporation" required>
                                <span asp-validation-for="OrganizationLegalNameEn" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="OrganizationLegalNameAr" class="form-label">
                                    Legal Name (Arabic)
                                </label>
                                <input asp-for="OrganizationLegalNameAr" class="form-control" dir="rtl"
                                       placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµØ±ÙÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label asp-for="TradeName" class="form-label">
                                Trade Name / Brand (if different)
                            </label>
                            <input asp-for="TradeName" class="form-control"
                                   placeholder="e.g., SABC">
                        </div>
                    </div>
                </div>

                <!-- Section: Geographic Information -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-globe me-2"></i>Geographic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="CountryOfIncorporation" class="form-label">
                                    <span class="text-danger">*</span> Country of Incorporation
                                </label>
                                <select asp-for="CountryOfIncorporation" class="form-select" required>
                                    <option value="">-- Select Country --</option>
                                    <option value="SA">Saudi Arabia ðŸ‡¸ðŸ‡¦</option>
                                    <option value="AE">United Arab Emirates ðŸ‡¦ðŸ‡ª</option>
                                    <option value="QA">Qatar ðŸ‡¶ðŸ‡¦</option>
                                    <option value="KW">Kuwait ðŸ‡°ðŸ‡¼</option>
                                    <option value="BH">Bahrain ðŸ‡§ðŸ‡­</option>
                                    <option value="OM">Oman ðŸ‡´ðŸ‡²</option>
                                    <option value="EG">Egypt ðŸ‡ªðŸ‡¬</option>
                                    <option value="JO">Jordan ðŸ‡¯ðŸ‡´</option>
                                </select>
                                <span asp-validation-for="CountryOfIncorporation" class="text-danger small"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="PrimaryHqLocation" class="form-label">
                                    Primary HQ Location
                                </label>
                                <input asp-for="PrimaryHqLocation" class="form-control"
                                       placeholder="e.g., Riyadh, Saudi Arabia">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="DefaultTimezone" class="form-label">
                                    Default Timezone
                                </label>
                                <select asp-for="DefaultTimezone" class="form-select">
                                    <option value="Asia/Riyadh">Asia/Riyadh (GMT+3)</option>
                                    <option value="Asia/Dubai">Asia/Dubai (GMT+4)</option>
                                    <option value="Asia/Qatar">Asia/Qatar (GMT+3)</option>
                                    <option value="Asia/Kuwait">Asia/Kuwait (GMT+3)</option>
                                    <option value="Africa/Cairo">Africa/Cairo (GMT+2)</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Operating Countries/Jurisdictions</label>
                            <div class="row">
                                @{
                                    var countries = new[] {
                                        ("SA", "Saudi Arabia"), ("AE", "UAE"), ("QA", "Qatar"),
                                        ("KW", "Kuwait"), ("BH", "Bahrain"), ("OM", "Oman"),
                                        ("EG", "Egypt"), ("JO", "Jordan"), ("LB", "Lebanon")
                                    };
                                }
                                @foreach (var (code, name) in countries)
                                {
                                    <div class="col-md-3 col-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input operating-country"
                                                   name="OperatingCountries" value="@code" id="country_@code"
                                                   @(Model.OperatingCountries.Contains(code) ? "checked" : "")>
                                            <label class="form-check-label" for="country_@code">@name</label>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section: Organization Type & Industry -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-industry me-2"></i>Organization Type & Industry</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="OrganizationType" class="form-label">
                                    <span class="text-danger">*</span> Organization Type
                                </label>
                                <select asp-for="OrganizationType" class="form-select" required id="orgTypeSelect">
                                    <option value="">-- Select Type --</option>
                                    <option value="enterprise">Enterprise (1000+ employees)</option>
                                    <option value="sme">SME (51-999 employees)</option>
                                    <option value="startup">Startup (1-50 employees)</option>
                                    <option value="government">Government Entity</option>
                                    <option value="regulated_fi">Regulated Financial Institution</option>
                                    <option value="fintech">Fintech</option>
                                    <option value="telecom">Telecommunications</option>
                                    <option value="healthcare">Healthcare Provider</option>
                                    <option value="other">Other</option>
                                </select>
                                <span asp-validation-for="OrganizationType" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="IndustrySector" class="form-label">
                                    <span class="text-danger">*</span> Industry/Sector
                                </label>
                                <select asp-for="IndustrySector" class="form-select" required id="sectorSelect">
                                    <option value="">-- Select Sector --</option>
                                    <option value="Banking">Banking & Financial Services</option>
                                    <option value="Insurance">Insurance</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Telecom">Telecommunications</option>
                                    <option value="Energy">Energy & Utilities</option>
                                    <option value="Government">Government & Public Sector</option>
                                    <option value="Retail">Retail & E-Commerce</option>
                                    <option value="Technology">Technology & Software</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Education">Education</option>
                                    <option value="RealEstate">Real Estate</option>
                                    <option value="Transportation">Transportation & Logistics</option>
                                    <option value="Other">Other</option>
                                </select>
                                <span asp-validation-for="IndustrySector" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Business Lines (optional)</label>
                            <div class="row">
                                @{
                                    var businessLines = new[] {
                                        "retail", "corporate", "payments", "lending", "wealth",
                                        "insurance", "investment", "telecom_services", "ict_services"
                                    };
                                }
                                @foreach (var bl in businessLines)
                                {
                                    <div class="col-md-3 col-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input"
                                                   name="BusinessLines" value="@bl" id="bl_@bl"
                                                   @(Model.BusinessLines.Contains(bl) ? "checked" : "")>
                                            <label class="form-check-label" for="bl_@bl">
                                                @System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(bl.Replace("_", " ").ToLower())
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section: Communication & Verification -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Communication & Verification</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="PrimaryLanguage" class="form-label">
                                    Primary Language
                                </label>
                                <select asp-for="PrimaryLanguage" class="form-select">
                                    <option value="bilingual">Bilingual (English + Arabic)</option>
                                    <option value="english">English Only</option>
                                    <option value="arabic">Arabic Only</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="DomainVerificationMethod" class="form-label">
                                    Domain Verification Method
                                </label>
                                <select asp-for="DomainVerificationMethod" class="form-select">
                                    <option value="admin_email">Admin Email Confirmation</option>
                                    <option value="dns_txt">DNS TXT Record</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Corporate Email Domains</label>
                            <div id="emailDomainsContainer">
                                @if (Model.CorporateEmailDomains.Any())
                                {
                                    foreach (var domain in Model.CorporateEmailDomains)
                                    {
                                        <div class="input-group mb-2 email-domain-row">
                                            <span class="input-group-text">@@</span>
                                            <input type="text" class="form-control" name="CorporateEmailDomains"
                                                   value="@domain" placeholder="company.com">
                                            <button type="button" class="btn btn-outline-danger remove-domain">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="input-group mb-2 email-domain-row">
                                        <span class="input-group-text">@@</span>
                                        <input type="text" class="form-control" name="CorporateEmailDomains"
                                               placeholder="company.com">
                                        <button type="button" class="btn btn-outline-danger remove-domain">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                }
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addEmailDomain">
                                <i class="fas fa-plus me-1"></i> Add Domain
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section: Data Residency -->
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-database me-2"></i>Data Residency</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="hasDataResidency"
                                   asp-for="HasDataResidencyRequirement">
                            <label class="form-check-label" for="hasDataResidency">
                                <strong>Data residency requirement applies</strong>
                            </label>
                            <small class="text-muted d-block">
                                Enable if regulatory requirements mandate data must be stored in specific countries.
                            </small>
                        </div>

                        <div id="dataResidencyCountries" style="display: @(Model.HasDataResidencyRequirement ? "block" : "none");">
                            <label class="form-label">Data Residency Countries</label>
                            <div class="row">
                                @foreach (var (code, name) in countries)
                                {
                                    <div class="col-md-3 col-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input"
                                                   name="DataResidencyCountries" value="@code" id="dr_@code"
                                                   @(Model.DataResidencyCountries.Contains(code) ? "checked" : "")>
                                            <label class="form-check-label" for="dr_@code">@name</label>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <div>
                        <a href="@Url.Action("Index", "Dashboard")" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-times me-1"></i> Cancel
                        </a>
                    </div>
                    <div>
                        <a href="@Url.Action("SaveAndExit", "OnboardingWizard", new { tenantId = ViewBag.TenantId })"
                           class="btn btn-warning me-2"
                           onclick="return confirm('Save your progress and exit? You can continue later.');">
                            <i class="fas fa-save me-1"></i> Save & Continue Later
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            Save & Continue to Step B
                            <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Toggle data residency countries visibility
        document.getElementById('hasDataResidency').addEventListener('change', function() {
            document.getElementById('dataResidencyCountries').style.display = this.checked ? 'block' : 'none';
        });

        // Add email domain
        document.getElementById('addEmailDomain').addEventListener('click', function() {
            const container = document.getElementById('emailDomainsContainer');
            const row = document.createElement('div');
            row.className = 'input-group mb-2 email-domain-row';
            row.innerHTML = `
                <span class="input-group-text">@@</span>
                <input type="text" class="form-control" name="CorporateEmailDomains" placeholder="company.com">
                <button type="button" class="btn btn-outline-danger remove-domain">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(row);
        });

        // Remove email domain
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-domain')) {
                const row = e.target.closest('.email-domain-row');
                if (document.querySelectorAll('.email-domain-row').length > 1) {
                    row.remove();
                } else {
                    row.querySelector('input').value = '';
                }
            }
        });

        // Validation display
        const validationSummary = document.querySelector('[data-valmsg-summary]');
        if (validationSummary && validationSummary.textContent.trim()) {
            validationSummary.style.display = 'block';
        }
    </script>
}
