@{
    ViewData["Title"] = "GRC Dashboard - Compliance Overview";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 text-dark">
                <i class="fas fa-tachometer-alt"></i> Compliance Dashboard
            </h1>
            <p class="text-muted">Real-time overview of your organization's compliance status</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-outline-primary" onclick="location.reload()">
                <i class="fas fa-sync"></i> Refresh
            </button>
            <a href="@Url.Action("Create", "Plans")" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Plan
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-left border-primary shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Active Plans</h6>
                            <h2 class="text-primary mb-0" id="activePlansCount">-</h2>
                        </div>
                        <i class="fas fa-chart-line text-primary fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-left border-success shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Completed</h6>
                            <h2 class="text-success mb-0" id="completedPlansCount">-</h2>
                        </div>
                        <i class="fas fa-check-circle text-success fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-left border-warning shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Baselines</h6>
                            <h2 class="text-warning mb-0" id="baselinesCount">-</h2>
                        </div>
                        <i class="fas fa-layer-group text-warning fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-left border-info shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Controls</h6>
                            <h2 class="text-info mb-0" id="controlsCount">-</h2>
                        </div>
                        <i class="fas fa-list-check text-info fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Recent Plans -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks text-primary"></i> Recent Assessment Plans
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="plansTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Plan</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Start Date</th>
                                    <th>Target End</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Organization Profile -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-building text-success"></i> Organization
                    </h5>
                </div>
                <div class="card-body" id="orgProfileSection">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-info"></i> Recent Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline" id="activityTimeline">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin"></i> Loading activity...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Badge Helper -->
<script>
    function getStatusBadge(status) {
        const badges = {
            'Draft': '<span class="badge bg-secondary">Draft</span>',
            'Active': '<span class="badge bg-primary">Active</span>',
            'Paused': '<span class="badge bg-warning text-dark">Paused</span>',
            'Completed': '<span class="badge bg-success">Completed</span>',
            'Archived': '<span class="badge bg-dark">Archived</span>'
        };
        return badges[status] || `<span class="badge bg-gray">${status}</span>`;
    }

    function getTypeBadge(type) {
        const badges = {
            'QuickScan': '<span class="badge bg-info">Quick Scan</span>',
            'Full': '<span class="badge bg-primary">Full</span>',
            'Remediation': '<span class="badge bg-warning text-dark">Remediation</span>',
            'Custom': '<span class="badge bg-secondary">Custom</span>'
        };
        return badges[type] || `<span class="badge bg-gray">${type}</span>`;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', function () {
        const tenantId = localStorage.getItem('tenantId') || 'default-tenant';
        loadDashboardData(tenantId);
        loadRecentActivity(tenantId);
    });

    function loadDashboardData(tenantId) {
        // For now, use mock data. In production, fetch from API
        const mockData = {
            stats: {
                activePlans: 2,
                completedPlans: 5,
                activeBaselines: 6,
                estimatedControlCount: 288
            },
            recentPlans: [
                {
                    id: '1',
                    name: '2026 Q1 Full Assessment',
                    planType: 'Full',
                    status: 'Active',
                    startDate: '2026-01-04',
                    targetEndDate: '2026-02-28'
                },
                {
                    id: '2',
                    name: 'PDPL Compliance Review',
                    planType: 'QuickScan',
                    status: 'Active',
                    startDate: '2026-01-06',
                    targetEndDate: '2026-01-27'
                },
                {
                    id: '3',
                    name: '2025 Year-End Assessment',
                    planType: 'Full',
                    status: 'Completed',
                    startDate: '2025-10-01',
                    targetEndDate: '2025-12-31'
                }
            ],
            organization: {
                name: 'Acme Corporation',
                type: 'Financial Services',
                sector: 'Banking',
                country: 'SA',
                size: 'Large',
                maturity: 'Managed'
            }
        };

        // Update stats
        document.getElementById('activePlansCount').textContent = mockData.stats.activePlans;
        document.getElementById('completedPlansCount').textContent = mockData.stats.completedPlans;
        document.getElementById('baselinesCount').textContent = mockData.stats.activeBaselines;
        document.getElementById('controlsCount').textContent = mockData.stats.estimatedControlCount;

        // Update plans table
        const tbody = document.querySelector('#plansTable tbody');
        tbody.innerHTML = mockData.recentPlans.map(plan => `
        <tr>
            <td>
                <strong>${plan.name}</strong>
            </td>
            <td>${getTypeBadge(plan.planType)}</td>
            <td>${getStatusBadge(plan.status)}</td>
            <td>${formatDate(plan.startDate)}</td>
            <td>${formatDate(plan.targetEndDate)}</td>
            <td>
                <a href="/Plans/Details/${plan.id}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i>
                </a>
            </td>
        </tr>
    `).join('');

        // Update organization profile
        const orgSection = document.getElementById('orgProfileSection');
        orgSection.innerHTML = `
        <dl class="row">
            <dt class="col-sm-6">Organization:</dt>
            <dd class="col-sm-6"><strong>${mockData.organization.name}</strong></dd>
            
            <dt class="col-sm-6">Type:</dt>
            <dd class="col-sm-6">${mockData.organization.type}</dd>
            
            <dt class="col-sm-6">Sector:</dt>
            <dd class="col-sm-6">${mockData.organization.sector}</dd>
            
            <dt class="col-sm-6">Country:</dt>
            <dd class="col-sm-6">${mockData.organization.country}</dd>
            
            <dt class="col-sm-6">Size:</dt>
            <dd class="col-sm-6">${mockData.organization.size}</dd>
            
            <dt class="col-sm-6">Maturity:</dt>
            <dd class="col-sm-6"><span class="badge bg-success">${mockData.organization.maturity}</span></dd>
        </dl>
        <a href="@Url.Action("Edit", "Organization")" class="btn btn-sm btn-outline-secondary w-100">
            <i class="fas fa-edit"></i> Edit Profile
        </a>
    `;
    }

    function loadRecentActivity(tenantId) {
        const mockActivity = [
            { type: 'PlanCreated', message: 'New plan created: 2026 Q1 Full Assessment', time: '2 hours ago', icon: 'fa-plus-circle', color: 'primary' },
            { type: 'PlanStatusUpdated', message: 'PDPL Compliance Review marked as Active', time: '5 hours ago', icon: 'fa-check-circle', color: 'success' },
            { type: 'RulesetEvaluated', message: 'Compliance scope derived from rules engine', time: '1 day ago', icon: 'fa-cogs', color: 'info' },
            { type: 'ProfileUpdated', message: 'Organization profile updated', time: '2 days ago', icon: 'fa-edit', color: 'warning' },
            { type: 'OnboardingCompleted', message: 'Organization onboarding completed', time: '3 days ago', icon: 'fa-flag-checkered', color: 'success' }
        ];

        const timeline = document.getElementById('activityTimeline');
        timeline.innerHTML = mockActivity.map(activity => `
        <div class="d-flex mb-3">
            <div class="flex-shrink-0">
                <span class="badge bg-${activity.color} p-2">
                    <i class="fas ${activity.icon}"></i>
                </span>
            </div>
            <div class="flex-grow-1 ms-3">
                <p class="mb-0"><strong>${activity.message}</strong></p>
                <small class="text-muted">${activity.time}</small>
            </div>
        </div>
    `).join('');
    }
</script>