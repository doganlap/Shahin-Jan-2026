@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<GrcMvc.Resources.SharedResource> L
@{
    ViewData["Title"] = L["MainDashboard"];
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4">
    <!-- Success Message -->
    @if (ViewBag.SuccessMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i> @ViewBag.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Onboarding Incomplete Banner -->
    @if (ViewBag.OnboardingIncomplete == true)
    {
        <div class="alert alert-warning border-warning shadow-sm mb-4" role="alert">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="alert-icon bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                    </div>
                </div>
                <div class="col">
                    <h5 class="alert-heading mb-1">
                        <i class="bi bi-rocket me-2"></i>أكمل إعداد مؤسستك
                    </h5>
                    <p class="mb-0">لم تكتمل عملية الإعداد بعد. أكمل الخطوات المتبقية للحصول على خطة امتثال مخصصة لمؤسستك.</p>
                </div>
                <div class="col-auto">
                    <a href="@ViewBag.OnboardingUrl" class="btn btn-warning btn-lg shadow-sm">
                        <i class="bi bi-arrow-left-circle me-2"></i>استكمال الإعداد
                    </a>
                </div>
            </div>
        </div>
    }

    <!-- Role-Based Dashboard Section -->
    @await Html.PartialAsync("_RoleBasedDashboard")

    <!-- Detailed Stats Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="section-title mb-3">
                <i class="bi bi-graph-up text-primary"></i> @L["Statistics"]
            </h5>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-left border-primary shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Active Plans</h6>
                            <h2 class="text-primary mb-0" id="activePlansCount">-</h2>
                        </div>
                        <i class="fas fa-chart-line text-primary fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-left border-success shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Completed</h6>
                            <h2 class="text-success mb-0" id="completedPlansCount">-</h2>
                        </div>
                        <i class="fas fa-check-circle text-success fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-left border-warning shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Baselines</h6>
                            <h2 class="text-warning mb-0" id="baselinesCount">-</h2>
                        </div>
                        <i class="fas fa-layer-group text-warning fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-left border-info shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted text-uppercase mb-1">Controls</h6>
                            <h2 class="text-info mb-0" id="controlsCount">-</h2>
                        </div>
                        <i class="fas fa-list-check text-info fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Recent Plans -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks text-primary"></i> Recent Assessment Plans
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="plansTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Plan</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Start Date</th>
                                    <th>Target End</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Organization Profile -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-building text-success"></i> Organization
                    </h5>
                </div>
                <div class="card-body" id="orgProfileSection">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>

            <!-- Applicable Baselines -->
            <div class="card shadow mt-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group text-warning"></i> Applicable Baselines
                    </h5>
                </div>
                <div class="card-body">
                    @if (ViewBag.Baselines != null && ((IEnumerable<dynamic>)ViewBag.Baselines).Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var baseline in (IEnumerable<dynamic>)ViewBag.Baselines)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong class="text-primary">@baseline.BaselineCode</strong>
                                        <br />
                                        <small class="text-muted">@baseline.ReasonJson</small>
                                    </div>
                                    <span class="badge bg-success">Active</span>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-info-circle"></i> No baselines derived yet.
                            <br />
                            <small>Complete onboarding to derive your compliance scope.</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-info"></i> Recent Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline" id="activityTimeline">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin"></i> Loading activity...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Badge Helper -->
<script>
    function getStatusBadge(status) {
        const badges = {
            'Draft': '<span class="badge bg-secondary">Draft</span>',
            'Active': '<span class="badge bg-primary">Active</span>',
            'Paused': '<span class="badge bg-warning text-dark">Paused</span>',
            'Completed': '<span class="badge bg-success">Completed</span>',
            'Archived': '<span class="badge bg-dark">Archived</span>'
        };
        return badges[status] || `<span class="badge bg-gray">${status}</span>`;
    }

    function getTypeBadge(type) {
        const badges = {
            'QuickScan': '<span class="badge bg-info">Quick Scan</span>',
            'Full': '<span class="badge bg-primary">Full</span>',
            'Remediation': '<span class="badge bg-warning text-dark">Remediation</span>',
            'Custom': '<span class="badge bg-secondary">Custom</span>'
        };
        return badges[type] || `<span class="badge bg-gray">${type}</span>`;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', function () {
        const tenantId = localStorage.getItem('tenantId') || 'default-tenant';
        loadDashboardData(tenantId);
        loadRecentActivity(tenantId);
    });

    async function loadDashboardData(tenantId) {
        try {
            // Fetch dashboard data from API
            const response = await fetch('/api/dashboard/summary');
            const result = await response.json();

            let stats = { activePlans: 0, completedPlans: 0, activeBaselines: 0, estimatedControlCount: 0 };
            let recentPlans = [];
            let organization = {};

            if (result.success && result.data) {
                stats = result.data.stats || stats;
                recentPlans = result.data.recentPlans || [];
                organization = result.data.organization || {};
            }

            // Update stats
            document.getElementById('activePlansCount').textContent = stats.activePlans || 0;
            document.getElementById('completedPlansCount').textContent = stats.completedPlans || 0;
            document.getElementById('baselinesCount').textContent = stats.activeBaselines || 0;
            document.getElementById('controlsCount').textContent = stats.estimatedControlCount || 0;

            // Update plans table
            renderPlansTable(recentPlans);

            // Update organization profile
            renderOrgProfile(organization);

        } catch (error) {
            console.error('Error loading dashboard:', error);
            // Show defaults on error
            document.getElementById('activePlansCount').textContent = '-';
            document.getElementById('completedPlansCount').textContent = '-';
            document.getElementById('baselinesCount').textContent = '-';
            document.getElementById('controlsCount').textContent = '-';
        }
    }

    function renderPlansTable(recentPlans) {
        const tbody = document.querySelector('#plansTable tbody');
        if (!recentPlans || recentPlans.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No plans found</td></tr>';
            return;
        }

        // Update plans table with actual data
        tbody.innerHTML = recentPlans.map(plan => `
        <tr>
            <td>
                <strong>${plan.name}</strong>
            </td>
            <td>${getTypeBadge(plan.planType)}</td>
            <td>${getStatusBadge(plan.status)}</td>
            <td>${formatDate(plan.startDate)}</td>
            <td>${formatDate(plan.targetEndDate)}</td>
            <td>
                <a href="/Plans/Details/${plan.id}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i>
                </a>
            </td>
        </tr>
    `).join('');

    }

    function renderOrgProfile(organization) {
        const orgSection = document.getElementById('orgProfileSection');
        if (!organization || !organization.name) {
            orgSection.innerHTML = '<p class="text-muted">No organization profile available</p>';
            return;
        }

        orgSection.innerHTML = `
        <dl class="row">
            <dt class="col-sm-6">Organization:</dt>
            <dd class="col-sm-6"><strong>${organization.name || '-'}</strong></dd>

            <dt class="col-sm-6">Type:</dt>
            <dd class="col-sm-6">${organization.type || '-'}</dd>

            <dt class="col-sm-6">Sector:</dt>
            <dd class="col-sm-6">${organization.sector || '-'}</dd>

            <dt class="col-sm-6">Country:</dt>
            <dd class="col-sm-6">${organization.country || '-'}</dd>

            <dt class="col-sm-6">Size:</dt>
            <dd class="col-sm-6">${organization.size || '-'}</dd>

            <dt class="col-sm-6">Maturity:</dt>
            <dd class="col-sm-6"><span class="badge bg-success">${organization.maturity || 'N/A'}</span></dd>
        </dl>
        <a href="@Url.Action("Edit", "Organization")" class="btn btn-sm btn-outline-secondary w-100">
            <i class="fas fa-edit"></i> Edit Profile
        </a>
    `;
    }

    async function loadRecentActivity(tenantId) {
        try {
            const response = await fetch(`/api/dashboard/activity?tenantId=${tenantId || ''}`);
            const result = await response.json();

            let activities = [];
            if (result.success && result.data) {
                activities = result.data;
            }

            const timeline = document.getElementById('activityTimeline');
            if (!activities || activities.length === 0) {
                timeline.innerHTML = '<p class="text-muted text-center py-3">No recent activity</p>';
                return;
            }

            timeline.innerHTML = activities.map(activity => `
            <div class="d-flex mb-3">
                <div class="flex-shrink-0">
                    <span class="badge bg-${activity.color || 'secondary'} p-2">
                        <i class="fas ${activity.icon || 'fa-circle'}"></i>
                    </span>
                </div>
                <div class="flex-grow-1 ms-3">
                    <p class="mb-0"><strong>${activity.message || activity.type}</strong></p>
                    <small class="text-muted">${activity.time || ''}</small>
                </div>
            </div>
        `).join('');
        } catch (error) {
            console.error('Error loading activity:', error);
            document.getElementById('activityTimeline').innerHTML = '<p class="text-muted text-center py-3">Unable to load activity</p>';
        }
    }
</script>