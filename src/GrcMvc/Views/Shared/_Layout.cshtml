@using Microsoft.AspNetCore.Localization
@using Microsoft.AspNetCore.Mvc.Localization
@using GrcMvc.Resources
@using GrcMvc.Services
@inject IHtmlLocalizer<SharedResource> L
@inject IAppInfoService AppInfo
@{
    var requestCulture = Context.Features.Get<IRequestCultureFeature>();
    var currentCulture = requestCulture?.RequestCulture?.UICulture?.Name ?? "ar";
    var isRtl = currentCulture == "ar";
    var htmlLang = currentCulture;
    var htmlDir = isRtl ? "rtl" : "ltr";
}
<!DOCTYPE html>
<html lang="@htmlLang" dir="@htmlDir">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - @AppInfo.Name</title>
    <link rel="icon" type="image/x-icon" href="~/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="~/images/brand/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="~/images/brand/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="128x128" href="~/images/brand/favicon-128.png" />
    <meta name="application-name" content="@AppInfo.Name" />
    <meta name="author" content="@AppInfo.CompanyName" />
    <meta name="culture" content="@currentCulture" />
    <!-- Google Fonts for Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    @if (isRtl)
    {
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" />
    }
    else
    {
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    }
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/tailwind.output.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/help-styles.css" asp-append-version="true" />
    @if (isRtl)
    {
        <link rel="stylesheet" href="~/css/rtl.css" asp-append-version="true" />
    }
    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-dark bg-dark border-bottom box-shadow mb-3">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" asp-area="" asp-controller="Home" asp-action="Index">
                    <img src="~/images/brand/eagle-logo-32.png" alt="@AppInfo.Name" width="28" height="28" class="me-2" />
                    <span>@AppInfo.Name</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        @if (User.Identity?.IsAuthenticated != true)
                        {
                            <!-- Unauthenticated: Only show Start Free Trial (login is in top right) -->
                            <li class="nav-item">
                                <a class="nav-link btn btn-warning text-dark fw-bold px-3 mx-2" href="/trial">
                                    <i class="bi bi-rocket-takeoff-fill me-1"></i> ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑŸÖÿ¨ÿßŸÜŸäÿ©
                                </a>
                            </li>
                        }
                        @{
                            // Define role-based access - check user roles
                            var isAdmin = User.Identity?.IsAuthenticated == true && (User.IsInRole("Admin") || User.IsInRole("PlatformAdmin") || User.IsInRole("TenantAdmin"));
                            var isComplianceUser = isAdmin || (User.Identity?.IsAuthenticated == true && (User.IsInRole("ComplianceManager") || User.IsInRole("Auditor")));
                            var isRiskUser = isAdmin || (User.Identity?.IsAuthenticated == true && (User.IsInRole("RiskManager") || User.IsInRole("ComplianceManager")));
                            var isPolicyUser = isAdmin || (User.Identity?.IsAuthenticated == true && (User.IsInRole("ComplianceManager") || User.IsInRole("PolicyManager")));
                            var isAuditUser = isAdmin || (User.Identity?.IsAuthenticated == true && (User.IsInRole("Auditor") || User.IsInRole("ComplianceManager")));
                            var isEvidenceUser = isAdmin || (User.Identity?.IsAuthenticated == true && (User.IsInRole("EvidenceOfficer") || User.IsInRole("ComplianceManager") || User.IsInRole("Auditor")));
                            var isWorkflowUser = isAdmin || (User.Identity?.IsAuthenticated == true && (User.IsInRole("ComplianceManager") || User.IsInRole("RiskManager")));
                            var isReportsUser = isAdmin || (User.Identity?.IsAuthenticated == true && (User.IsInRole("ComplianceManager") || User.IsInRole("RiskManager") || User.IsInRole("Auditor") || User.IsInRole("Viewer")));
                        }
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            @* Risk Management - Only for Risk/Compliance roles *@
                            @if (isRiskUser)
                            {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-light" href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-exclamation-triangle"></i> @L["Nav_RiskManagement"]
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" asp-controller="Risk" asp-action="Index"><i class="bi bi-exclamation-diamond me-2"></i>@L["Risks"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="Control" asp-action="Index"><i class="bi bi-shield-check me-2"></i>@L["Controls"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="Control" asp-action="Matrix"><i class="bi bi-grid-3x3 me-2"></i>@L["ControlMatrix"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="Assessment" asp-action="Index"><i class="bi bi-clipboard-check me-2"></i>@L["Assessments"]</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" asp-controller="Risk" asp-action="Report"><i class="bi bi-bar-chart me-2"></i>@L["RiskReports"]</a></li>
                                </ul>
                            </li>
                            }
                            
                            @* Compliance - Only for Compliance/Audit roles *@
                            @if (isComplianceUser)
                            {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-light" href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-clipboard-check"></i> @L["Nav_Compliance"]
                                </a>
                                <ul class="dropdown-menu">
                                    @if (isPolicyUser)
                                    {
                                    <li><a class="dropdown-item" asp-controller="Policy" asp-action="Index"><i class="bi bi-file-text me-2"></i>@L["Policies"]</a></li>
                                    }
                                    @if (isAuditUser)
                                    {
                                    <li><a class="dropdown-item" asp-controller="Audit" asp-action="Index"><i class="bi bi-search me-2"></i>@L["Audits"]</a></li>
                                    }
                                    @if (isEvidenceUser)
                                    {
                                    <li><a class="dropdown-item" asp-controller="Evidence" asp-action="Index"><i class="bi bi-file-earmark-check me-2"></i>@L["Evidence"]</a></li>
                                    <li><a class="dropdown-item" href="/evidence/lifecycle"><i class="bi bi-arrow-repeat me-2"></i>@L["EvidenceLifecycle"]</a></li>
                                    }
                                    <li><hr class="dropdown-divider"></li>
                                    @if (isPolicyUser)
                                    {
                                    <li><a class="dropdown-item" asp-controller="Policy" asp-action="Statistics"><i class="bi bi-pie-chart me-2"></i>@L["PolicyStatistics"]</a></li>
                                    }
                                    @if (isAuditUser)
                                    {
                                    <li><a class="dropdown-item" asp-controller="Audit" asp-action="Statistics"><i class="bi bi-bar-chart me-2"></i>@L["AuditStatistics"]</a></li>
                                    }
                                    @if (isEvidenceUser)
                                    {
                                    <li><a class="dropdown-item" asp-controller="Evidence" asp-action="Statistics"><i class="bi bi-graph-up me-2"></i>@L["EvidenceStatistics"]</a></li>
                                    }
                                </ul>
                            </li>
                            }
                            @* Dashboards - Available to all authenticated users *@
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-light" href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-speedometer2"></i> @L["Nav_Dashboards"]
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/dashboard"><i class="bi bi-graph-up me-2"></i>@L["MainDashboard"]</a></li>
                                    @if (isAdmin || User.IsInRole("Executive") || User.IsInRole("ComplianceManager"))
                                    {
                                    <li><a class="dropdown-item" href="/dashboard/executive"><i class="bi bi-speedometer2 me-2"></i>ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ŸÜŸÅŸäÿ∞Ÿäÿ©</a></li>
                                    }
                                    @if (isAdmin || User.IsInRole("ComplianceManager") || User.IsInRole("WorkflowManager"))
                                    {
                                    <li><a class="dropdown-item" href="/dashboard/operations"><i class="bi bi-gear-wide-connected me-2"></i>ŸÑŸàÿ≠ÿ© ÿßŸÑÿπŸÖŸÑŸäÿßÿ™</a></li>
                                    }
                                    @if (isAdmin || User.IsInRole("SecurityAnalyst"))
                                    {
                                    <li><a class="dropdown-item" href="/dashboard/security"><i class="bi bi-shield-lock me-2"></i>ŸÑŸàÿ≠ÿ© ÿßŸÑÿ£ŸÖÿßŸÜ</a></li>
                                    }
                                    @if (isAdmin || User.IsInRole("ComplianceManager"))
                                    {
                                    <li><a class="dropdown-item" href="/dashboard/data-quality"><i class="bi bi-database-check me-2"></i>ÿ¨ŸàÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</a></li>
                                    }
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/inbox"><i class="bi bi-inbox me-2"></i>@L["Inbox"]</a></li>
                                </ul>
                            </li>
                            
                            @* Shahin-AI - Only for Compliance/Risk/Admin roles *@
                            @if (isComplianceUser || isRiskUser)
                            {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-warning" href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-shield-alt"></i> @L["Nav_ShahinAI"]
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" asp-controller="ShahinAI" asp-action="Index"><i class="fas fa-tachometer-alt me-2"></i>@L["Nav_Dashboard"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="ShahinAIIntegration" asp-action="Index"><i class="fas fa-project-diagram me-2 text-info"></i>@L["IntegratedFlow"]</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" asp-controller="ShahinAI" asp-action="Map"><i class="fas fa-map me-2 text-primary"></i>@L["MAP_ControlLibrary"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="ShahinAI" asp-action="Apply"><i class="fas fa-check-circle me-2 text-success"></i>@L["APPLY_Scope"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="ShahinAI" asp-action="Prove"><i class="fas fa-file-alt me-2" style="color:#9B59B6;"></i>@L["PROVE_Evidence"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="ShahinAI" asp-action="Watch"><i class="fas fa-eye me-2 text-danger"></i>@L["WATCH_Monitoring"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="ShahinAI" asp-action="Fix"><i class="fas fa-wrench me-2 text-warning"></i>@L["FIX_Remediation"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="ShahinAI" asp-action="Vault"><i class="fas fa-lock me-2" style="color:#1ABC9C;"></i>@L["VAULT_Repository"]</a></li>
                                </ul>
                            </li>
                            }
                            
                            @* Manage - Only for Admin/Manager roles *@
                            @if (isAdmin || User.IsInRole("ComplianceManager") || User.IsInRole("RiskManager"))
                            {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-light" href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cogs"></i> @L["Nav_Manage"]
                                </a>
                                <ul class="dropdown-menu">
                                    @if (isAdmin)
                                    {
                                    <li><a class="dropdown-item" asp-controller="RoleProfile" asp-action="Index"><i class="fas fa-user-shield me-2 text-primary"></i>@L["RoleProfiles"]</a></li>
                                    }
                                    <li><a class="dropdown-item" asp-controller="AssessmentTemplate" asp-action="Index"><i class="fas fa-clipboard-list me-2 text-info"></i>@L["AssessmentTemplates"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="DocumentFlow" asp-action="Index"><i class="fas fa-file-upload me-2 text-success"></i>@L["DocumentFlow"]</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" asp-controller="CCM" asp-action="Index"><i class="fas fa-robot me-2 text-info"></i>@L["CCMTests"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="KRIDashboard" asp-action="Index"><i class="fas fa-chart-line me-2 text-danger"></i>@L["KRIDashboard"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="Exception" asp-action="Index"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>@L["Exceptions"]</a></li>
                                    @if (isAuditUser)
                                    {
                                    <li><a class="dropdown-item" asp-controller="AuditPackage" asp-action="Index"><i class="fas fa-archive me-2 text-success"></i>@L["AuditPackages"]</a></li>
                                    }
                                    <li><hr class="dropdown-divider"></li>
                                    @if (isAdmin)
                                    {
                                    <li><a class="dropdown-item" asp-controller="Invitation" asp-action="Index"><i class="fas fa-user-plus me-2 text-primary"></i>@L["Invitations"]</a></li>
                                    }
                                    @if (isReportsUser)
                                    {
                                    <li><a class="dropdown-item" asp-controller="Reports" asp-action="Index"><i class="fas fa-chart-bar me-2" style="color:#9B59B6;"></i>@L["Reports"]</a></li>
                                    }
                                    <li><a class="dropdown-item" asp-controller="RoleProfile" asp-action="MyProfile"><i class="fas fa-user me-2"></i>@L["MyProfile"]</a></li>
                                </ul>
                            </li>
                            }
                            
                            @* Workflows - Only for users with workflow access *@
                            @if (isWorkflowUser)
                            {
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-light" href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-diagram-3"></i> @L["Nav_Workflows"]
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" asp-controller="Workflow" asp-action="Index"><i class="bi bi-list me-2"></i>@L["AllWorkflows"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="Workflow" asp-action="ByStatus" asp-route-status="Active"><i class="bi bi-lightning me-2"></i>@L["ActiveWorkflows"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="Workflow" asp-action="Statistics"><i class="bi bi-bar-chart me-2"></i>@L["Statistics"]</a></li>
                                </ul>
                            </li>
                            }
                            <li class="nav-item dropdown help-menu">
                                <a class="nav-link dropdown-toggle text-light" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-question-circle"></i> @L["Nav_Help"]
                                </a>
                                <ul class="dropdown-menu dropdown-menu-dark">
                                    <li>
                                        <a class="dropdown-item" asp-controller="Help" asp-action="Index">
                                            <i class="bi bi-house me-2"></i>@L["HelpCenter"]
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" asp-controller="Help" asp-action="GettingStarted">
                                            <i class="bi bi-rocket me-2"></i>@L["GettingStarted"]
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" asp-controller="Help" asp-action="FAQ">
                                            <i class="bi bi-question-circle me-2"></i>@L["FAQ"]
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" asp-controller="Help" asp-action="Glossary">
                                            <i class="bi bi-book me-2"></i>@L["Glossary"]
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" asp-controller="DocumentCenter" asp-action="Index">
                                            <i class="bi bi-folder me-2"></i>ŸÖÿ±ŸÉÿ≤ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ | Document Center
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" asp-controller="Help" asp-action="Contact">
                                            <i class="bi bi-envelope me-2"></i>@L["ContactSupport"]
                                        </a>
                                    </li>
                                </ul>
                            </li>
                            @* Reports link - Only for users with report access *@
                            @if (isReportsUser)
                            {
                            <li class="nav-item">
                                <a class="nav-link text-light" asp-controller="Home" asp-action="Reports">
                                    <i class="bi bi-file-earmark-bar-graph"></i> @L["Reports"]
                                </a>
                            </li>
                            }
                            
                            @* Admin Menu - Only for Admin roles *@
                            @if (isAdmin)
                            {
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle text-light" href="#" role="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-gear"></i> @L["Nav_Admin"]
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" asp-controller="TenantAdmin" asp-action="Index"><i class="fas fa-building me-2 text-primary"></i>@L["TenantAdmin"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="CatalogAdmin" asp-action="Index"><i class="fas fa-database me-2 text-info"></i>@L["CatalogAdmin"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="RoleDelegation" asp-action="Index"><i class="fas fa-people-arrows me-2 text-success"></i>@L["RoleDelegation"]</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" asp-controller="Notifications" asp-action="Index"><i class="fas fa-bell me-2 text-warning"></i>@L["Nav_Notifications"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="Subscription" asp-action="Index"><i class="fas fa-credit-card me-2 text-success"></i>@L["Nav_Subscription"]</a></li>
                                        <li><a class="dropdown-item" asp-controller="Subscription" asp-action="WebhookLogs"><i class="fas fa-plug me-2 text-secondary"></i>@L["WebhookLogs"]</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" asp-controller="Analytics" asp-action="Index"><i class="fas fa-chart-pie me-2" style="color:#9B59B6;"></i>@L["Analytics"]</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" asp-controller="EmailOperations" asp-action="Index"><i class="fas fa-envelope-open-text me-2 text-info"></i>ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ®ÿ±ŸäÿØ</a></li>
                                    </ul>
                                </li>
                            }
                        }
                    </ul>
                    <ul class="navbar-nav">
                        <!-- Global Search -->
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            <li class="nav-item me-2">
                                <form class="d-flex" action="@Url.Action("Search", "Home")" method="get">
                                    <div class="input-group input-group-sm">
                                        <input type="text" name="q" class="form-control bg-dark text-light border-secondary"
                                               placeholder="@L["Search"]..." style="width: 200px;" aria-label="Search">
                                        <button class="btn btn-outline-secondary" type="submit">
                                            <i class="bi bi-search text-light"></i>
                                        </button>
                                    </div>
                                </form>
                            </li>
                        }
                        <!-- Language Switcher -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-light" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-globe"></i>
                                @if (currentCulture == "ar")
                                {
                                    <text>ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</text>
                                }
                                else if (currentCulture == "tr")
                                {
                                    <text>T√ºrk√ße</text>
                                }
                                else
                                {
                                    <text>English</text>
                                }
                            </a>
                            <ul class="dropdown-menu @(isRtl ? "dropdown-menu-start" : "dropdown-menu-end")">
                                <li>
                                    <a class="dropdown-item @(currentCulture == "ar" ? "active" : "")" asp-controller="Home" asp-action="SetLanguage" asp-route-culture="ar" asp-route-returnUrl="@Context.Request.Path">
                                        <i class="bi bi-flag me-2"></i>üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                                        @if (currentCulture == "ar")
                                        {
                                            <i class="bi bi-check-lg float-end"></i>
                                        }
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item @(currentCulture == "en" ? "active" : "")" asp-controller="Home" asp-action="SetLanguage" asp-route-culture="en" asp-route-returnUrl="@Context.Request.Path">
                                        <i class="bi bi-flag me-2"></i>üá∫üá∏ English
                                        @if (currentCulture == "en")
                                        {
                                            <i class="bi bi-check-lg float-end"></i>
                                        }
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item @(currentCulture == "tr" ? "active" : "")" asp-controller="Home" asp-action="SetLanguage" asp-route-culture="tr" asp-route-returnUrl="@Context.Request.Path">
                                        <i class="bi bi-flag me-2"></i>üáπüá∑ T√ºrk√ße
                                        @if (currentCulture == "tr")
                                        {
                                            <i class="bi bi-check-lg float-end"></i>
                                        }
                                    </a>
                                </li>
                            </ul>
                        </li>
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            @await Component.InvokeAsync("WorkspaceSwitcher")
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-light d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                                    <span class="user-avatar bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">
                                        @{
                                            var userName = User.Identity?.Name ?? "";
                                            var initials = userName.Length > 0 ? userName.Substring(0, 1).ToUpper() : "U";
                                            if (userName.Contains(" "))
                                            {
                                                var parts = userName.Split(' ');
                                                initials = parts[0].Substring(0, 1).ToUpper();
                                                if (parts.Length > 1 && parts[1].Length > 0)
                                                {
                                                    initials += parts[1].Substring(0, 1).ToUpper();
                                                }
                                            }
                                            else if (userName.Contains("@@"))
                                            {
                                                initials = userName.Substring(0, 1).ToUpper();
                                            }
                                        }
                                        @initials
                                    </span>
                                    @{
                                        // Get display name - prefer actual name over email
                                        var displayName = User.FindFirst("FullName")?.Value 
                                            ?? User.FindFirst(System.Security.Claims.ClaimTypes.GivenName)?.Value
                                            ?? User.FindFirst("name")?.Value;
                                        var userEmail = User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? User.Identity?.Name ?? "";
                                        
                                        // If no name claim, extract from email
                                        if (string.IsNullOrEmpty(displayName) && !string.IsNullOrEmpty(userEmail))
                                        {
                                            var emailPart = userEmail.Split('@')[0];
                                            // Convert "john.doe" or "johndoe" to "John Doe"
                                            if (!string.IsNullOrEmpty(emailPart))
                                            {
                                                var parts = emailPart.Split(new[] { '.', '_', '-' }, StringSplitOptions.RemoveEmptyEntries);
                                                displayName = string.Join(" ", parts.Select(p => 
                                                    !string.IsNullOrEmpty(p) ? char.ToUpper(p[0]) + (p.Length > 1 ? p.Substring(1).ToLower() : "") : ""));
                                            }
                                        }
                                    }
                                    <span class="fw-bold d-none d-lg-inline">@displayName</span>
                                </a>
                                <ul class="dropdown-menu @(isRtl ? "dropdown-menu-start" : "dropdown-menu-end")">
                                    <li class="dropdown-header">
                                        <div class="d-flex align-items-center">
                                            <span class="user-avatar bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px; font-size: 1rem;">@initials</span>
                                            <div>
                                                <div class="fw-bold">@displayName</div>
                                                <small class="text-muted">@userEmail</small>
                                            </div>
                                        </div>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" asp-controller="Dashboard" asp-action="Index"><i class="bi bi-speedometer2 me-2"></i>@L["Dashboard"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="Account" asp-action="Profile"><i class="bi bi-person me-2"></i>@L["Nav_Profile"]</a></li>
                                    <li><a class="dropdown-item" asp-controller="Inbox" asp-action="Index"><i class="bi bi-inbox me-2"></i>@L["Inbox"]</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form asp-controller="Account" asp-action="Logout" method="post">
                                            <button type="submit" class="dropdown-item text-danger"><i class="bi bi-box-arrow-right me-2"></i>@L["Nav_Logout"]</button>
                                        </form>
                                    </li>
                                </ul>
                            </li>
                        }
                        else
                        {
                            <!-- Simple login link for unauthenticated users -->
                            <li class="nav-item">
                                <a class="nav-link text-light" asp-controller="Account" asp-action="Login">
                                    <i class="bi bi-person-circle me-1"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    <div class="container-fluid">
        <!-- Alert Messages -->
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-circle"></i> @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="border-top footer text-muted bg-dark mt-5">
        <div class="container-fluid py-3">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <img src="~/images/brand/favicon-32.png" alt="@AppInfo.Name" width="24" height="24" class="me-2 opacity-75" />
                        <span class="text-light">@AppInfo.FooterText</span>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <span class="text-secondary" style="font-size: 0.85rem;">
                        Powered by 
                        <a href="@AppInfo.CompanyUrl" target="_blank" rel="noopener" class="text-info text-decoration-none fw-bold">
                            <i class="bi bi-lightning-charge-fill"></i> @AppInfo.CompanyName
                        </a>
                    </span>
                </div>
                <div class="col-md-4 @(isRtl ? "text-start" : "text-end")">
                    <span class="text-secondary small me-3">@AppInfo.VersionDisplay</span>
                    <a asp-controller="Help" asp-action="Index" class="text-light text-decoration-none @(isRtl ? "ms-3" : "me-3")">ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©</a>
                    <a asp-controller="Help" asp-action="Contact" class="text-light text-decoration-none">ÿßŸÑÿØÿπŸÖ ÿßŸÑŸÅŸÜŸä</a>
                </div>
            </div>
        </div>
    </footer>

    @* Support Chat Widget *@
    @await Html.PartialAsync("_SupportChatWidget")

    @* Help System Components *@
    @await Html.PartialAsync("_GlossaryModal")
    @await Html.PartialAsync("_WelcomeTour")

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/localization.js" asp-append-version="true"></script>
    <script src="~/js/language-switcher.js" asp-append-version="true"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/help-system.js" asp-append-version="true"></script>
    <script src="~/js/tour.js" asp-append-version="true"></script>

    <script>
        async function switchWorkspace(workspaceId) {
            try {
                const response = await fetch('/api/workspace/switch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ workspaceId: workspaceId })
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('@L["Error_WorkspaceSwitchFailed"].Value');
                }
            } catch (error) {
                console.error('Error switching workspace:', error);
                alert('@L["Error_WorkspaceSwitchError"].Value');
            }
        }
    </script>

    <script>
        $(document).ready(function() {
            // Initialize help system
            if (typeof HelpSystem !== 'undefined') {
                HelpSystem.init();
            }

            // Check for first login tour
            @if (ViewBag.ShowWelcomeTour == true)
            {
                <text>
                window.showWelcomeTour = true;
                </text>
            }
        });
    </script>

    <!-- Toast Notifications -->
    @await Html.PartialAsync("_ToastNotifications")

    <!-- Loading Indicator -->
    @await Html.PartialAsync("_LoadingIndicator")

    <!-- Form Validation -->
    @await Html.PartialAsync("_FormValidation")

    <!-- AI Assistant (Shahin) -->
    @if (User.Identity?.IsAuthenticated == true)
    {
        @await Html.PartialAsync("_AIAssistant")
    }

    <!-- Theme Toggle and Mobile Optimizations -->
    @await Html.PartialAsync("_ThemeAndMobile")

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
