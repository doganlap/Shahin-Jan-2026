<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRC System - Architecture Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }
        h3 {
            color: #7f8c8d;
            margin-top: 20px;
        }
        .mermaid {
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .description {
            color: #555;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .toc {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 30px;
        }
        .toc ul {
            list-style: none;
            padding-left: 0;
        }
        .toc li {
            margin: 8px 0;
        }
        .toc a {
            color: #3498db;
            text-decoration: none;
        }
        .toc a:hover {
            text-decoration: underline;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GRC System - Architecture Diagram Book</h1>
        <p class="description">Complete visual documentation of the GRC system architecture, design patterns, and data flows.</p>

        <div class="toc">
            <h3>Table of Contents</h3>
            <ul>
                <li><a href="#diagram1">1. System Layered Architecture</a></li>
                <li><a href="#diagram2">2. Policy Enforcement Flow</a></li>
                <li><a href="#diagram3">3. Authorization and Permission Flow</a></li>
                <li><a href="#diagram4">4. Request Processing Flow</a></li>
                <li><a href="#diagram5">5. Component Interaction Diagram</a></li>
                <li><a href="#diagram6">6. Policy Rule Evaluation Logic</a></li>
                <li><a href="#diagram7">7. Data Flow: Evidence Creation Example</a></li>
            </ul>
        </div>
    </div>

    <div class="container" id="diagram1">
        <h2>1. System Layered Architecture</h2>
        <p class="description">Shows the complete layered architecture from Blazor UI through API layer, Application layer, Domain layer, to Infrastructure layer following ABP Framework patterns.</p>
        <div class="mermaid">
graph TB
    subgraph presentation["Presentation Layer"]
        Blazor["Blazor WebAssembly<br/>Grc.Blazor"]
        Menu["Arabic Menu<br/>GrcMenuContributor"]
        Pages["56 Razor Pages"]
        ApiClient["ApiClientService"]
    end

    subgraph api["API Layer"]
        HttpApi["HTTP API Host<br/>Grc.HttpApi.Host"]
        Middleware["Middleware Pipeline<br/>Auth, CORS, Security"]
        Swagger["Swagger/OpenAPI"]
    end

    subgraph application["Application Layer"]
        AppServices["19 AppServices<br/>Evidence, Risk, Assessment..."]
        PolicyEngine["Policy Engine<br/>PolicyEnforcer"]
        PolicyStore["Policy Store<br/>YAML Loader"]
        Validators["FluentValidation"]
        Mapper["AutoMapper"]
    end

    subgraph contracts["Application Contracts"]
        DTOs["DTOs<br/>CreateDto, UpdateDto"]
        Interfaces["AppService Interfaces"]
        Permissions["Permission Definitions"]
    end

    subgraph domain["Domain Layer"]
        Entities["14 Domain Entities<br/>Evidence, Risk, Audit..."]
        Repositories["Repository Interfaces"]
        Seed["Seed Data Contributors"]
    end

    subgraph infrastructure["Infrastructure Layer"]
        EF["Entity Framework Core<br/>Grc.EntityFrameworkCore"]
        DbContext["GrcDbContext"]
        Database["SQL Server Database"]
    end

    Blazor --> ApiClient
    Menu --> Blazor
    Pages --> Blazor
    ApiClient -->|HTTP/REST| HttpApi
    HttpApi --> Middleware
    HttpApi --> Swagger
    Middleware --> AppServices
    AppServices --> PolicyEngine
    AppServices --> Validators
    AppServices --> Mapper
    PolicyEngine --> PolicyStore
    AppServices --> DTOs
    AppServices --> Interfaces
    AppServices --> Entities
    Entities --> Repositories
    Repositories --> EF
    EF --> DbContext
    DbContext --> Database
    Seed --> Entities
        </div>
    </div>

    <div class="container" id="diagram2">
        <h2>2. Policy Enforcement Flow</h2>
        <p class="description">Detailed sequence diagram showing how policy evaluation works from user action through policy enforcement to final decision.</p>
        <div class="mermaid">
sequenceDiagram
    participant User
    participant Blazor
    participant AppService
    participant PolicyEnforcer
    participant PolicyStore
    participant DotPathResolver
    participant MutationApplier
    participant AuditLogger
    participant Database

    User->>Blazor: Create Evidence Action
    Blazor->>AppService: POST /api/evidence
    AppService->>AppService: Check Permission<br/>Grc.Evidence.Upload
    AppService->>PolicyEnforcer: EnforceAsync(context)

    PolicyEnforcer->>PolicyStore: LoadPolicyAsync()
    PolicyStore-->>PolicyEnforcer: Policy Document (YAML)

    PolicyEnforcer->>PolicyEnforcer: Get Active Exceptions
    PolicyEnforcer->>PolicyEnforcer: Sort Rules by Priority

    loop For Each Rule
        PolicyEnforcer->>PolicyEnforcer: Check Exception Match
        alt Exception Matches
            PolicyEnforcer->>PolicyEnforcer: Skip Rule
        else No Exception
            PolicyEnforcer->>PolicyEnforcer: Match Rule<br/>(Resource Type, Environment)
            alt Rule Matches
                PolicyEnforcer->>DotPathResolver: Evaluate Conditions<br/>(when clauses)
                DotPathResolver-->>PolicyEnforcer: Condition Result
                alt Condition True
                    PolicyEnforcer->>PolicyEnforcer: Apply Rule Effect
                    alt Effect = deny
                        PolicyEnforcer->>AuditLogger: Log Decision
                        PolicyEnforcer-->>AppService: PolicyViolationException
                        AppService-->>Blazor: 400 Bad Request<br/>with remediation hint
                    else Effect = mutate
                        PolicyEnforcer->>MutationApplier: Apply Mutations
                        MutationApplier-->>PolicyEnforcer: Mutated Resource
                    else Effect = allow
                        PolicyEnforcer->>PolicyEnforcer: Continue
                    end
                end
            end
        end
    end

    alt All Rules Passed
        PolicyEnforcer->>AuditLogger: Log Decision (allow)
        PolicyEnforcer-->>AppService: Success
        AppService->>Database: Insert Entity
        Database-->>AppService: Entity Saved
        AppService-->>Blazor: EvidenceDto
        Blazor-->>User: Success Toast
    end
        </div>
    </div>

    <div class="container" id="diagram3">
        <h2>3. Authorization and Permission Flow</h2>
        <p class="description">Complete authorization flow from user action through menu visibility, page access, API permission checks, and policy enforcement.</p>
        <div class="mermaid">
flowchart TD
    Start([User Action]) --> Auth{Authenticated?}
    Auth -->|No| Login[Redirect to Login]
    Auth -->|Yes| GetRoles[Get User Roles]

    GetRoles --> CheckMenu{Menu Item<br/>Permission Check}
    CheckMenu -->|No Permission| HideMenu[Hide Menu Item]
    CheckMenu -->|Has Permission| ShowMenu[Show Menu Item]

    ShowMenu --> UserClick[User Clicks Menu]
    UserClick --> PageLoad[Load Blazor Page]
    PageLoad --> AuthorizeView{AuthorizeView<br/>Component}

    AuthorizeView -->|No Permission| HideContent[Hide Protected Content]
    AuthorizeView -->|Has Permission| ShowContent[Show Page Content]

    ShowContent --> UserAction[User Performs Action<br/>e.g., Create Evidence]
    UserAction --> ApiCall[API Call to Backend]

    ApiCall --> JWT[Validate JWT Token]
    JWT -->|Invalid| Reject[401 Unauthorized]
    JWT -->|Valid| CheckPermission[Check Permission<br/>Authorize Attribute]

    CheckPermission -->|No Permission| Reject403[403 Forbidden]
    CheckPermission -->|Has Permission| ExecuteService[Execute AppService]

    ExecuteService --> PolicyCheck[Policy Enforcement]
    PolicyCheck -->|Deny| PolicyViolation[PolicyViolationException<br/>400 with remediation]
    PolicyCheck -->|Allow| Success[Operation Success]

    HideMenu --> End([End])
    HideContent --> End
    Reject --> End
    Reject403 --> End
    PolicyViolation --> End
    Success --> End
        </div>
    </div>

    <div class="container" id="diagram4">
        <h2>4. Request Processing Flow</h2>
        <p class="description">Complete request lifecycle from browser interaction through all middleware layers, authentication, authorization, business logic, and database persistence.</p>
        <div class="mermaid">
sequenceDiagram
    participant Browser
    participant Blazor
    participant ApiClient
    participant Middleware
    participant Auth
    participant AppService
    participant Policy
    participant Repository
    participant Database

    Browser->>Blazor: User Interaction
    Blazor->>Blazor: Validate Permission<br/>(UI Level)
    Blazor->>ApiClient: PostAsync(endpoint, dto)

    ApiClient->>Middleware: HTTP Request<br/>with JWT Token

    Middleware->>Middleware: CorrelationIdMiddleware<br/>Add Correlation ID
    Middleware->>Middleware: SecurityHeadersMiddleware<br/>Add Security Headers
    Middleware->>Middleware: GlobalExceptionHandler<br/>Wrap in try-catch

    Middleware->>Auth: Validate JWT Token
    Auth-->>Middleware: User Identity + Roles

    Middleware->>Auth: Check Permission<br/>[Authorize] Attribute
    Auth-->>Middleware: Permission Granted

    Middleware->>AppService: Route to AppService<br/>e.g., EvidenceAppService.CreateAsync()

    AppService->>AppService: FluentValidation<br/>Validate DTO

    AppService->>Policy: EnforceAsync(action, resourceType, resource)
    Policy->>Policy: Load Policy from YAML
    Policy->>Policy: Evaluate Rules
    Policy-->>AppService: Allow/Deny Decision

    alt Policy Denies
        AppService-->>Middleware: PolicyViolationException
        Middleware-->>ApiClient: 400 Bad Request<br/>with remediation
        ApiClient-->>Blazor: Error Response
        Blazor-->>Browser: Error Toast
    else Policy Allows
        AppService->>AppService: Map DTO to Entity<br/>(AutoMapper)
        AppService->>Repository: InsertAsync(entity)
        Repository->>Database: INSERT INTO Evidence
        Database-->>Repository: Entity Saved
        Repository-->>AppService: Entity with ID
        AppService->>AppService: Map Entity to DTO
        AppService-->>Middleware: EvidenceDto
        Middleware-->>ApiClient: 200 OK with DTO
        ApiClient-->>Blazor: Success Response
        Blazor-->>Browser: Success Toast + Update UI
    end
        </div>
    </div>

    <div class="container" id="diagram5">
        <h2>5. Component Interaction Diagram</h2>
        <p class="description">Shows relationships and dependencies between major system components.</p>
        <div class="mermaid">
graph LR
    subgraph ui["UI Components"]
        Menu[GrcMenuContributor]
        Pages[Blazor Pages]
        Client[ApiClientService]
    end

    subgraph services["Application Services"]
        EvidenceSvc[EvidenceAppService]
        RiskSvc[RiskAppService]
        AssessmentSvc[AssessmentAppService]
        BaseSvc[BasePolicyAppService]
    end

    subgraph policy["Policy Engine"]
        Enforcer[PolicyEnforcer]
        Store[PolicyStore]
        Resolver[DotPathResolver]
        Mutator[MutationApplier]
        Logger[PolicyAuditLogger]
    end

    subgraph permissions["Permission System"]
        PermDefs[GrcPermissions]
        PermProvider[GrcPermissionDefinitionProvider]
        RoleResolver[RoleResolver]
    end

    subgraph domain["Domain"]
        Entities[Domain Entities]
        Repos[Repositories]
    end

    subgraph data["Data Access"]
        EF[EF Core]
        DB[(SQL Server)]
    end

    Menu --> PermDefs
    Pages --> Client
    Client --> EvidenceSvc
    EvidenceSvc --> BaseSvc
    RiskSvc --> BaseSvc
    AssessmentSvc --> BaseSvc
    BaseSvc --> Enforcer
    BaseSvc --> RoleResolver
    Enforcer --> Store
    Enforcer --> Resolver
    Enforcer --> Mutator
    Enforcer --> Logger
    Enforcer --> PermProvider
    BaseSvc --> Entities
    Entities --> Repos
    Repos --> EF
    EF --> DB
    PermProvider --> PermDefs
        </div>
    </div>

    <div class="container" id="diagram6">
        <h2>6. Policy Rule Evaluation Logic</h2>
        <p class="description">Detailed flowchart showing the deterministic policy evaluation algorithm.</p>
        <div class="mermaid">
flowchart TD
    Start([PolicyEnforcer.EnforceAsync]) --> LoadPolicy[Load Policy from YAML]
    LoadPolicy --> GetExceptions[Get Active Exceptions<br/>Not Expired + Match Context]
    GetExceptions --> SortRules[Sort Rules by Priority<br/>Ascending Order]

    SortRules --> LoopStart{For Each Rule}

    LoopStart --> CheckException{Exception<br/>Applies?}
    CheckException -->|Yes| SkipRule[Skip Rule]
    CheckException -->|No| MatchRule{Match Rule?<br/>Resource Type<br/>Environment<br/>Principal}

    MatchRule -->|No| NextRule[Next Rule]
    MatchRule -->|Yes| EvalConditions[Evaluate When Conditions<br/>Dot-Path Resolution]

    EvalConditions --> AllTrue{All Conditions<br/>True?}
    AllTrue -->|No| NextRule
    AllTrue -->|Yes| CheckEffect{Effect Type?}

    CheckEffect -->|deny| DenyDecision[Decision: DENY]
    CheckEffect -->|allow| AllowDecision[Decision: ALLOW]
    CheckEffect -->|mutate| ApplyMutation[Apply Mutations<br/>Update Resource]
    CheckEffect -->|audit| LogAudit[Log Audit Event]

    ApplyMutation --> ContinueEval[Continue Evaluation]
    LogAudit --> ContinueEval
    AllowDecision --> CheckShortCircuit{Short Circuit<br/>Enabled?}

    CheckShortCircuit -->|Yes| StopEval[Stop Evaluation]
    CheckShortCircuit -->|No| NextRule

    DenyDecision --> ConflictStrategy{Conflict Strategy?}
    ConflictStrategy -->|denyOverrides| FinalDeny[Final: DENY]
    ConflictStrategy -->|allowOverrides| CheckOther[Check Other Rules]
    ConflictStrategy -->|highestPriority| UsePriority[Use Highest Priority]

    SkipRule --> NextRule
    NextRule --> LoopStart
    ContinueEval --> NextRule

    StopEval --> FinalAllow[Final: ALLOW]
    FinalDeny --> ThrowException[Throw PolicyViolationException]
    FinalAllow --> LogDecision[Log Decision to Audit]
    ThrowException --> End([End])
    LogDecision --> End
        </div>
    </div>

    <div class="container" id="diagram7">
        <h2>7. Data Flow: Evidence Creation Example</h2>
        <p class="description">Step-by-step data flow for creating evidence, showing validation, transformation, persistence, and output stages.</p>
        <div class="mermaid">
flowchart LR
    subgraph input["Input"]
        UserInput[User Fills Form<br/>CreateEvidenceDto]
    end

    subgraph validation["Validation"]
        FluentVal[FluentValidation<br/>Validate DTO]
        PolicyVal[Policy Enforcement<br/>Check Rules]
    end

    subgraph transformation["Transformation"]
        AutoMap[AutoMapper<br/>DTO → Entity]
        Mutation[Apply Mutations<br/>if needed]
    end

    subgraph persistence["Persistence"]
        Repo[Repository<br/>InsertAsync]
        EF[EF Core<br/>SaveChanges]
        DB[(Database)]
    end

    subgraph output["Output"]
        EntityMap[AutoMapper<br/>Entity → DTO]
        Response[Return EvidenceDto]
    end

    UserInput --> FluentVal
    FluentVal --> PolicyVal
    PolicyVal --> AutoMap
    AutoMap --> Mutation
    Mutation --> Repo
    Repo --> EF
    EF --> DB
    DB --> EntityMap
    EntityMap --> Response
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            }
        });
    </script>
</body>
</html>
